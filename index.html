<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ספירה לאחור</title>
    <script>
        // מצב ברירת מחדל ושחזור הגדרות שמורות
        let countDownDate = new Date("Jun 25, 2026 19:00:00").getTime();
        let x;
        let animationStarted = false;
        const savedDate = localStorage.getItem('weddingDate');
        const savedTitle = localStorage.getItem('weddingTitle');
        const savedBackground = localStorage.getItem('weddingBackground');
        if (savedDate) { countDownDate = new Date(savedDate).getTime(); }
        if (savedTitle) { document.title = savedTitle; }

        function startCountdown() {
            clearInterval(x);
            x = setInterval(function () {
                const now = new Date().getTime();
                const distance = countDownDate - now;
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                const el = document.getElementById("countdown");
                if (el) {
                    el.innerHTML = "<strong>" + days + ": " + hours + ": " + minutes + ": " + seconds + "</strong><br>" +
                                   "<small>שניות    דקות    שעות    ימים</small>";
                }
                if (distance < 0) {
                    clearInterval(x);
                    if (el) el.textContent = "כבר זוצים:)";
                }
            }, 1000);
        }

        function changeDate() {
            const newDate = document.getElementById("datePicker").value;
            const newTime = document.getElementById("timePicker").value || "19:00";
            if (newDate) {
                countDownDate = new Date(newDate + " " + newTime + ":00").getTime();
                localStorage.setItem('weddingDate', new Date(countDownDate).toString());
            }
            updateCurrentDateDisplay();
        }
        // עדכון תאריך נוכחי מהאחסון המקומי
        function updateCurrentDateDisplay() {
            const el = document.getElementById("currentDate");
            const saved = localStorage.getItem('weddingDate');
            if (saved) {
                const d = new Date(saved);
                // פורמט DD/MM/YYYY HH:MM
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                const hours = String(d.getHours()).padStart(2, '0');
                const minutes = String(d.getMinutes()).padStart(2, '0');
                el.textContent = `${day}/${month}/${year} ${hours}:${minutes}`;
            } else {
                el.textContent = "לא נבחר תאריך";
            }
        }

        function changeTitle() {
            const newTitle = document.getElementById("titleInput").value;
            if (newTitle.trim()) {
                localStorage.setItem('weddingTitle', newTitle);
                const titleEl = document.getElementById("mainTitle");
                if (titleEl) titleEl.textContent = newTitle;
                document.title = newTitle;
            }
            updateCurrentTitleDisplay();
        }

        // עדכון הכותרת הנוכחית מהאחסון המקומי
        function updateCurrentTitleDisplay() {
            const el = document.getElementById('currentTitle');
            if (!el) return;
            const saved = localStorage.getItem('weddingTitle');
            el.textContent = saved && saved.trim() ? saved : 'ה-ח-ת-ו-נ-ה';
        }

        // עדכון רקע נוכחי מהאחסון המקומי (טקסט תיאורי)
        function updateCurrentBackgroundDisplay() {
            const el = document.getElementById('currentBackground');
            if (!el) return;
            const saved = localStorage.getItem('weddingBackground');
            const savedName = localStorage.getItem('weddingBackgroundName');
            if (saved && savedName) {
                // הצג את שם הקובץ (קצר אם ארוך מדי)
                const name = savedName.length > 30 ? savedName.slice(0,27) + '...' : savedName;
                el.textContent =  name;
            } else if (saved) {
                el.textContent = 'תמונה מותאמת אישית';
            } else {
                el.textContent = 'כסא כלה';
            }
        }

        function changeBackground() {
            const fileInput = document.getElementById("backgroundInput");
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageDataUrl = e.target.result;
                    // נסה לדחוס את התמונה לפני השמירה כדי להימנע ממחסור במקום ב-localStorage
                    compressAndSaveImage(imageDataUrl, 1600, 0.8)
                            .then(savedDataUrl => {
                                // שמירת שם הקובץ לשם הצגה
                                try { localStorage.setItem('weddingBackgroundName', file.name); } catch (e) { /* noop */ }
                                document.body.style.backgroundImage = `url(${savedDataUrl})`;
                                document.body.style.backgroundPosition = "center";
                                document.body.style.backgroundSize = "cover";
                                document.body.style.backgroundRepeat = "no-repeat";
                                document.body.style.backgroundAttachment = "fixed";
                                updateCurrentBackgroundDisplay();
                            })
                        .catch(err => {
                            alert('שגיאה בשמירת התמונה: ' + (err && err.message ? err.message : err));
                        });
                };
                reader.readAsDataURL(file);
            }
        }

        // דחיסה ושמירה של DataURL לתוך localStorage (מקטין מימדים ואיכות)
        function compressAndSaveImage(dataUrl, maxDim = 1600, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    // לחשב גודל חדש שמכבד את היחס המקורי
                    let { width, height } = img;
                    if (width > maxDim || height > maxDim) {
                        const ratio = width / height;
                        if (ratio > 1) {
                            width = maxDim;
                            height = Math.round(maxDim / ratio);
                        } else {
                            height = maxDim;
                            width = Math.round(maxDim * ratio);
                        }
                    }
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    try {
                        const compressed = canvas.toDataURL('image/jpeg', quality);
                        try {
                            localStorage.setItem('weddingBackground', compressed);
                            resolve(compressed);
                        } catch (e) {
                            // אם חריג של מקום - נסה עם איכות נמוכה יותר
                            if (quality > 0.2) {
                                // נסה שוב עם איכות קטנה בחצי
                                compressAndSaveImage(dataUrl, maxDim, Math.max(0.2, quality - 0.25))
                                    .then(resolve)
                                    .catch(reject);
                            } else {
                                reject(new Error('אין מספיק מקום ב-localStorage כדי לשמור את התמונה'));
                            }
                        }
                    } catch (err) {
                        reject(err);
                    }
                };
                img.onerror = function() { reject(new Error('לא ניתן לקרוא את קובץ התמונה')); };
                img.src = dataUrl;
            });
        }

        function resetBackground() {
            // שחזור ההגדרות המקוריות
            document.body.style.backgroundImage = "url('x.png')";
            document.body.style.backgroundPosition = "center";
            document.body.style.backgroundSize = "cover";
            document.body.style.backgroundRepeat = "no-repeat";
            document.body.style.backgroundAttachment = "fixed";
            
            localStorage.removeItem('weddingBackground');
            localStorage.removeItem('weddingBackgroundName');
            const bgInput = document.getElementById("backgroundInput");
            if (bgInput) bgInput.value = "";
            updateCurrentBackgroundDisplay();
        }

        function resetDate() {
            localStorage.removeItem('weddingDate');
            countDownDate = new Date("Jun 25, 2026 19:00:00").getTime();
            document.getElementById("datePicker").value = "";
            document.getElementById("timePicker").value = "19:00";
            updateCurrentDateDisplay();
        }

        function resetTitle() {
            localStorage.removeItem('weddingTitle');
            const titleEl2 = document.getElementById("mainTitle");
            if (titleEl2) titleEl2.textContent = "ה-ח-ת-ו-נ-ה";
            document.title = "ספירה לחתונה";
            document.getElementById("titleInput").value = "";
            updateCurrentTitleDisplay();
        }

        function resetAll() {
            resetDate();
            resetTitle();
            resetBackground();
        }

        function startWeddingCountdown() {
            window.countdownStarted = true;
            document.getElementById("settingsPanel").style.display = "none";
            const countdownElement = document.getElementById("countdown");
            countdownElement.style.display = "block";
            countdownElement.style.visibility = "visible";
            startCountdown();
            animationStarted = true;
            if (typeof startTextAnimation === 'function') {
                startTextAnimation();
            }
            const audio = document.getElementById('weddingAudio');
            if (audio) {
                audio.currentTime = 0;
                audio.style.display = 'block';
                audio.play().catch(()=>{});
            }
        }

        function startTextAnimation() {
            let growing = true;
            const textElement = document.getElementById('countdown');
            
            setInterval(() => {
                if (animationStarted) {
                    const currentSize = parseFloat(window.getComputedStyle(textElement).fontSize);
                    if (growing) {
                        textElement.style.fontSize = (currentSize + 2) + 'px';
                        if (currentSize > 120) growing = false;
                    } else {
                        textElement.style.fontSize = (currentSize - 2) + 'px';
                        if (currentSize < 20) growing = true;
                    }
                }
            }, 85);
        }

        // פונקציה להצגה/הסתרה של פאנל ההגדרות
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        window.addEventListener('DOMContentLoaded', function() {
            // טעינת הגדרות שמורות
            loadSavedSettings();
            updateCurrentDateDisplay();
            updateCurrentTitleDisplay();
            updateCurrentBackgroundDisplay();

            // הסתרת הספירה בהתחלה
            document.getElementById("countdown").style.display = "none";

            // משתנה לבדיקה אם הספירה כבר התחילה
            window.countdownStarted = false;

            // לחיצה על Enter תתחיל ספירה בכל מקום בדף
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !window.countdownStarted) {
                    startWeddingCountdown();
                }
            });
        });
        function loadSavedSettings() {
            // טעינת כותרת
            if (savedTitle) {
                const titleEl = document.getElementById("mainTitle");
                if (titleEl) titleEl.textContent = savedTitle;
                document.title = savedTitle;
            }

            // טעינת תמונת רקע
            if (savedBackground) {
                document.body.style.backgroundImage = `url(${savedBackground})`;
                document.body.style.backgroundPosition = "center";
                document.body.style.backgroundSize = "cover";
                document.body.style.backgroundRepeat = "no-repeat";
                document.body.style.backgroundAttachment = "fixed";
            } else {
                // וידוא שההגדרות המקוריות קיימות
                document.body.style.backgroundPosition = "center";
                document.body.style.backgroundSize = "cover";
                document.body.style.backgroundRepeat = "no-repeat";
                document.body.style.backgroundAttachment = "fixed";
            }
        }
    </script>
</head>
<body style="text-align: center; height: 100vh; background-image: url('x.png'); background-position: center; background-size: cover; background-repeat: no-repeat; background-attachment: fixed; color: aliceblue; font: bold 70px arial; margin: 0; padding: 0;">
    <audio id="weddingAudio" loop preload="auto" style="display:none">
        <source src="חופה.mp3" type="audio/mpeg">
        <source src="חופה.mp3" type="audio/ogg">
    </audio>
    <!-- כפתור הגדרות בפינה השמאלית למעלה -->
    <button id="settingsButton" onclick="toggleSettings()" style="position: fixed; top: 40px; left: 20px; background: rgba(255,255,255,0.9); color: #333; border: none; border-radius: 8px; padding: 8px 12px; font-size: 16px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1001; font-weight: bold;">⚙️ הגדרות</button>
    
    <!-- הוראות שימוש -->
    <div style="position: fixed; top: 85px; left: 20px; background: rgba(255,255,255,0.8); color: black; padding: 6px 10px; border-radius: 6px; font-size: 13px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 1000; max-width: 250px;">
        לחצו אנטר בכל שלב כדי לעבור לספירה לאחור
    </div>
    
    <h1 id="mainTitle" style="margin-top: 80px;">ה-ח-ת-ו-נ-ה</h1>
    <!-- ספירה לאחור - מוסתרת בהתחלה, תוצג במרכז הדף -->
    <div id="countdown" style="color:black; display:none; font-size: 60px; margin: 40px 0 20px 0;"></div>
    <!-- פאנל הגדרות - מוסתר בהתחלה -->
    <div id="settingsPanel" style="position: fixed; top: 20px; left: 20px; width: 420px; min-width: 400px; background: rgba(255,255,255,0.96); padding: 25px; border-radius: 12px; color: black; font-size: 14px; box-shadow: 0 6px 20px rgba(0,0,0,0.25); z-index: 1000; max-height: 85vh; overflow-y: auto; border: 2px solid rgba(255,255,255,0.8); display: none;">
        <!-- <h3 style="margin-top: 0; font-size: 18px; text-align: center; color: #333; margin-bottom: 20px;">⚙️ הגדרות </h3> -->
        <div style="margin-top: 10px; font-size: 12px; color: #666;">
            לחצו אנטר בכל שלב כדי לעבור לספירה לאחור
        </div>
        <button onclick="toggleSettings()" style="float: right; background: #f44336; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 12px; cursor: pointer; margin-top: -10px;">✕</button>
        <!-- הגדרות תאריך -->
        <div style="border-bottom: 1px solid #eee; padding-bottom: 12px; margin-bottom: 12px;">
            <h4 style="margin: 10px 0; color: #555; font-size: 15px;">📅 זמן החתונה</h4>
            <p style="margin: 5px 0; font-size: 14px;"><strong>תאריך נוכחי:</strong> <span id="currentDate">לא נבחר תאריך</span></p>
            
            <div style="margin: 10px 0;">
                <label style="font-size: 13px;"><strong>תאריך החתונה: </strong></label><br>
                <input type="date" id="datePicker" style="font-size: 15px; padding: 8px; margin-top: 5px; border: 2px solid #ddd; border-radius: 5px; width: 100%; box-sizing: border-box;">
            </div>
            
            <div style="margin: 10px 0;">
                <label style="font-size: 13px;"><strong>שעת החתונה: </strong></label><br>
                <input type="time" id="timePicker" value="19:00" style="font-size: 15px; padding: 8px; margin-top: 5px; border: 2px solid #ddd; border-radius: 5px; width: 100%; box-sizing: border-box;">
            </div>
            
            <div style="margin: 10px 0;">
                <button onclick="changeDate()" style="font-size: 12px; padding: 6px 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 2px;">💾 שמור</button>
                <button onclick="resetDate()" style="font-size: 12px; padding: 6px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 2px;">🔄 איפוס</button>
            </div>
        </div>

        <!-- הגדרות כותרת -->
        <div style="border-bottom: 1px solid #eee; padding-bottom: 12px; margin-bottom: 12px;">
            <h4 style="margin: 10px 0; color: #555; font-size: 15px;">✏️ כותרת אישית</h4>
            <p style="margin: 5px 0; font-size: 14px;"><strong>כותרת נוכחית: </strong> <span id="currentTitle">ה-ח-ת-ו-נ-ה</span></p>
            
            <div style="margin: 10px 0;">
                <label style="font-size: 13px;"><strong>כותרת חדשה: </strong></label><br>
                <input type="text" id="titleInput" placeholder="David & Sara" style="font-size: 15px; padding: 8px; margin-top: 5px; border: 2px solid #ddd; border-radius: 5px; width: 100%; box-sizing: border-box;">
            </div>
            
            <div style="margin: 10px 0;">
                <button onclick="changeTitle()" style="font-size: 12px; padding: 6px 10px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 2px;">✏️ שמור</button>
                <button onclick="resetTitle()" style="font-size: 12px; padding: 6px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 2px;">🔄 איפוס</button>
            </div>
        </div>

        <!-- הגדרות רקע -->
        <div style="border-bottom: 1px solid #eee; padding-bottom: 12px; margin-bottom: 12px;">
            <h4 style="margin: 8px 0; color: #555; font-size: 14px;">🖼️ תמונת רקע</h4>
            <p style="margin: 5px 0; font-size: 14px;"><strong>רקע נוכחי:</strong> <span id="currentBackground">כסא כלה</span></p>
            
            <div style="margin: 10px 0;">
                <label style="font-size: 13px;"><strong>העלאת תמונה: </strong></label><br>
                <input type="file" id="backgroundInput" accept="image/*" style="font-size: 13px; padding: 6px; margin-top: 5px; border: 2px solid #ddd; border-radius: 5px; width: 100%; box-sizing: border-box;">
            </div>
            
            <div style="margin: 10px 0;">
                <button onclick="changeBackground()" style="font-size: 12px; padding: 6px 10px; background: #9C27B0; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 2px;">🖼️ שמור</button>
                <button onclick="resetBackground()" style="font-size: 12px; padding: 6px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 2px;">🔄 איפוס</button>
            </div>
        </div>
        
        <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #ddd;">
            <button onclick="startWeddingCountdown()" style="font-size: 18px; padding: 15px 30px; background: #FF6B6B; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;"> *התחל ספירה לאחור*</button>
        </div>
        
        
    </div>

</body>
</html>

